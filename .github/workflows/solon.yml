name: 'Solon AI QA Review'

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  analyze:
    name: Analyze Code Changes
    runs-on: ubuntu-latest
    steps:
      - name: 'Generate GitHub App Token'
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SOLON_APP_ID }}
          private-key: ${{ secrets.SOLON_PRIVATE_KEY }}

      - name: 'Check out code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Find existing Solon comment'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'solon-ai[bot]' # <-- FIX 1: Correct author name
          body-includes: 'üõ°Ô∏è Solon AI Review'

      - name: 'Get git diff'
        id: get_diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} --diff-filter=d --no-renames --text -- ':(exclude)*.lock' ':(exclude)*.min.*' > pr.diff
          DIFF_SIZE=$(wc -c < pr.diff)
          if [ "$DIFF_SIZE" -gt 200000 ]; then
            echo "Diff too large, truncating..."
            head -c 200000 pr.diff > pr_truncated.diff
            mv pr_truncated.diff pr.diff
          fi
          echo 'DIFF_CONTENT<<EOF' >> $GITHUB_ENV
          cat pr.diff >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: 'Call Solon API'
        id: call_api
        run: |
          JSON_PAYLOAD=$(cat pr.diff | jq -R -s '{diff: .}')
          API_RESPONSE=$(curl -s -w "%{http_code}" \
            --max-time 60 \
            -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "${{ secrets.SOLON_API_URL }}") # <-- FIX 2: Removed incorrect auth header
          
          HTTP_CODE="${API_RESPONSE: -3}"
          RESPONSE_BODY="${API_RESPONSE%???}"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Final JSON response: $RESPONSE_BODY"
            echo "comment_body=$RESPONSE_BODY" >> $GITHUB_OUTPUT
          else
            echo "API failed with HTTP $HTTP_CODE, using fallback"
            FALLBACK_JSON='{"summary":"API temporarily unavailable","edgeCases":["Unable to connect to Solon API"],"unitTests":{"code":"// API connection failed"}}'
            echo "comment_body=$FALLBACK_JSON" >> $GITHUB_OUTPUT
          fi

      - name: 'Post or Update AI Review Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ### üõ°Ô∏è Solon AI Review
            
            **Summary:** ${{ fromJson(steps.call_api.outputs.comment_body).summary || 'Analysis completed.' }}
            
            ---
            #### ü§î Suggested Edge Cases
            - ${{ fromJson(steps.call_api.outputs.comment_body).edgeCases[0] || 'No specific edge cases identified.' }}
            - ${{ fromJson(steps.call_api.outputs.comment_body).edgeCases[1] || '' }}
            
            ---
            #### üß™ Generated Unit Tests
            
            **Suggested File Path:** `${{ fromJson(steps.call_api.outputs.comment_body).unitTests.filePath || 'tests/' }}`
            
            ```${{ fromJson(steps.call_api.outputs.comment_body).unitTests.language || 'plaintext' }}
            ${{ fromJson(steps.call_api.outputs.comment_body).unitTests.code || '// No unit tests generated.' }}
            ```
            ---
            <sub>ü§ñ This review was generated by Solon AI.</sub>
