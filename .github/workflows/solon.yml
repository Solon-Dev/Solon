name: 'Solon AI QA Review'
on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  analyze:
    name: Analyze Code Changes
    runs-on: ubuntu-latest
    steps:
      - name: 'Check out PR branch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
          
      - name: 'Fetch base branch'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
      - name: 'Get git diff'
        id: get_diff
        run: |
          # Create diff between base and head
          git diff origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} > pr.diff
          
          # Check if diff is empty
          if [ ! -s pr.diff ]; then
            echo "No changes detected in the pull request"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Store diff content for API call
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "DIFF_CONTENT<<EOF" >> $GITHUB_ENV
          cat pr.diff >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: 'Call Solon API'
        if: steps.get_diff.outputs.has_changes == 'true'
        id: call_api
        run: |
          # Prepare JSON payload with proper escaping
          JSON_PAYLOAD=$(jq -n --arg diff "$DIFF_CONTENT" '{"diff": $diff}')
          
          # Call API with error handling
          API_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SOLON_API_TOKEN }}" \
            -d "$JSON_PAYLOAD" \
            "${{ secrets.SOLON_API_URL }}")
          
          # Extract response body and status code
          HTTP_CODE=$(echo "$API_RESPONSE" | tail -n 1)
          RESPONSE_BODY=$(echo "$API_RESPONSE" | head -n -1)
          
          # Check for API errors
          if [ "$HTTP_CODE" != "200" ]; then
            echo "API call failed with status code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          # Save response for next step
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: 'Generate GitHub App Token'
        if: steps.get_diff.outputs.has_changes == 'true'
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SOLON_APP_ID }}
          private-key: ${{ secrets.SOLON_PRIVATE_KEY }}
          
      - name: 'Post AI Review Comment'
        if: steps.get_diff.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.generate_token.outputs.token }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üõ°Ô∏è Solon AI Review
            
            ${{ fromJson(steps.call_api.outputs.comment_body).summary && format('**Summary:** {0}', fromJson(steps.call_api.outputs.comment_body).summary) || '**Summary:** Analysis complete' }}
            
            ---
            
            #### ü§î Suggested Edge Cases
            ${{ fromJson(steps.call_api.outputs.comment_body).edgeCases[0] && format('- {0}', fromJson(steps.call_api.outputs.comment_body).edgeCases[0]) || '- No edge cases identified' }}
            ${{ fromJson(steps.call_api.outputs.comment_body).edgeCases[1] && format('- {0}', fromJson(steps.call_api.outputs.comment_body).edgeCases[1]) || '' }}
            
            ---
            
            #### üß™ Generated Unit Tests
            ${{ fromJson(steps.call_api.outputs.comment_body).unitTests.filePath && format('*Suggested File Path:* `{0}`', fromJson(steps.call_api.outputs.comment_body).unitTests.filePath) || '*Suggested File Path:* `tests/test_main.ts`' }}
            
            ```${{ fromJson(steps.call_api.outputs.comment_body).unitTests.language || 'typescript' }}
            ${{ fromJson(steps.call_api.outputs.comment_body).unitTests.code || '// No unit tests generated' }}
            ```
