name: 'Solon AI QA Review'

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write

jobs:
  analyze:
    name: Analyze Code Changes
    runs-on: ubuntu-latest
    steps:
      - name: 'Check out code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Get git diff'
        uses: technote-space/get-diff-action@v6
        id: get_diff
        with:
          PATTERNS: |
            **/**

      - name: 'Call Solon API'
        id: call_api
        run: |
          JSON_PAYLOAD=$(jq -n --arg diff "${{ steps.get_diff.outputs.diff }}" '{"diff": $diff}')
          API_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          ${{ secrets.SOLON_API_URL }})
          echo "comment_body=$API_RESPONSE" >> $GITHUB_OUTPUT
      
      - name: 'Prepare Comment Body'
        id: prepare_comment
        run: |
          {
            echo 'comment_body<<EOF'
            echo '### ðŸ›¡ï¸ Solon AI Review'
            echo ''
            summary=$(jq -r '.summary // "No summary provided."' <<< '${{ steps.call_api.outputs.comment_body }}')
            echo "**Summary:** $summary"
            echo ''
            echo '---'
            echo ''
            edge_cases=$(jq -c '.edgeCases // []' <<< '${{ steps.call_api.outputs.comment_body }}')
            if [ "$(jq 'length' <<< "$edge_cases")" -gt 0 ]; then
              echo '#### ðŸ¤” Suggested Edge Cases'
              jq -r '.[]' <<< "$edge_cases" | while read -r line; do echo "- $line"; done
              echo ''
              echo '---'
              echo ''
            fi

            unit_tests=$(jq -c '.unitTests // null' <<< '${{ steps.call_api.outputs.comment_body }}')
            if [ "$unit_tests" != "null" ]; then
              echo '#### ðŸ§ª Generated Unit Tests'
              file_path=$(jq -r '.filePath // "No file path provided."' <<< "$unit_tests")
              language=$(jq -r '.language // ""' <<< "$unit_tests")
              code=$(jq -r '.code // "No code provided."' <<< "$unit_tests")
              echo "*Suggested File Path: \`$file_path\`*"
              echo "\`\`\`$language"
              echo "$code"
              echo "\`\`\`"
            fi
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: 'Post AI Review Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.prepare_comment.outputs.comment_body }}
