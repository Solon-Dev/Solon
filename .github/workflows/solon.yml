name: 'Solon AI QA Review'

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  analyze:
    name: Analyze Code Changes
    runs-on: ubuntu-latest
    steps:
      - name: 'Generate GitHub App Token'
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SOLON_APP_ID }}
          private-key: ${{ secrets.SOLON_PRIVATE_KEY }}

      - name: 'Check out code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Find existing Solon comment'
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          token: ${{ steps.app-token.outputs.token }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'solon-ai[bot]'
          body-includes: 'ðŸ›¡ï¸ Solon AI Review'

      - name: 'Get git diff'
        id: get_diff
        run: |
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- > pr.diff
          echo 'DIFF_CONTENT<<EOF' >> $GITHUB_ENV
          cat pr.diff >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: 'Call Solon API'
        id: call_api
        run: |
          JSON_PAYLOAD=$(cat pr.diff | jq -R -s '{diff: .}')
          API_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
          -d "$JSON_PAYLOAD" \
          ${{ secrets.SOLON_API_URL }})
          echo "comment_body=$API_RESPONSE" >> $GITHUB_OUTPUT
      
      - name: 'Post or Update AI Review Comment'
        uses: peter-evans/create-or-update-comment@v4
        with:
    token: ${{ steps.app-token.outputs.token }}
    issue-number: ${{ github.event.pull_request.number }}
    comment-id: ${{ steps.find-comment.outputs.comment-id }}
    edit-mode: replace
    body: ${{ fromJson(steps.call_api.outputs.comment_body).formatted }}
